# üîÑ Docker Compose con Auto-Updates (Watchtower)

# Este ejemplo muestra c√≥mo configurar Watchtower para actualizar autom√°ticamente
# tu aplicaci√≥n FastAPI cuando se publique una nueva imagen en Docker Hub.

version: '3.8'

services:
  # ============================================================================
  # APLICACI√ìN FASTAPI
  # ============================================================================
  fastapi-web:
    image: usuario/fastapi-web:1.5-alpine  # ‚Üê REEMPLAZAR con tu usuario de Docker Hub
    container_name: fastapi-web
    restart: unless-stopped
    
    ports:
      - "8000:8000"
    
    environment:
      - ENV=production
      - LOG_LEVEL=info
    
    # Labels para Watchtower
    labels:
      # Habilitar auto-update para este contenedor
      - "com.centurylinklabs.watchtower.enable=true"
      
      # No solo monitorear, sino actualizar autom√°ticamente
      - "com.centurylinklabs.watchtower.monitor-only=false"
    
    # Healthcheck para verificar que la app est√° funcionando
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - app-network

  # ============================================================================
  # WATCHTOWER (AUTO-UPDATER)
  # ============================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    
    volumes:
      # Necesario para que Watchtower pueda controlar Docker
      - /var/run/docker.sock:/var/run/docker.sock
    
    environment:
      # ========================================================================
      # CONFIGURACI√ìN B√ÅSICA
      # ========================================================================
      
      # Chequear cada hora (3600 segundos)
      # Valores comunes: 300 (5 min), 600 (10 min), 1800 (30 min), 3600 (1 hora)
      - WATCHTOWER_POLL_INTERVAL=3600
      
      # Solo actualizar contenedores con label "watchtower.enable=true"
      - WATCHTOWER_LABEL_ENABLE=true
      
      # Limpiar im√°genes viejas despu√©s de actualizar (ahorra espacio)
      - WATCHTOWER_CLEANUP=true
      
      # Incluir contenedores detenidos en el monitoreo
      - WATCHTOWER_INCLUDE_STOPPED=true
      
      # ========================================================================
      # NOTIFICACIONES (Opcional)
      # ========================================================================
      
      # Descomenta UNA de las siguientes opciones:
      
      # --- OPCI√ìN 1: Email ---
      # - WATCHTOWER_NOTIFICATIONS=email
      # - WATCHTOWER_NOTIFICATION_EMAIL_FROM=watchtower@example.com
      # - WATCHTOWER_NOTIFICATION_EMAIL_TO=admin@example.com
      # - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=smtp.gmail.com
      # - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=587
      # - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=your-email@gmail.com
      # - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=your-app-password
      
      # --- OPCI√ìN 2: Slack ---
      # - WATCHTOWER_NOTIFICATIONS=slack
      # - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=https://hooks.slack.com/services/XXX/YYY/ZZZ
      # - WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER=watchtower-production
      # - WATCHTOWER_NOTIFICATION_SLACK_CHANNEL=#deployments
      
      # --- OPCI√ìN 3: Discord ---
      # - WATCHTOWER_NOTIFICATIONS=discord
      # - WATCHTOWER_NOTIFICATION_DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/XXX/YYY
      # - WATCHTOWER_NOTIFICATION_DISCORD_IDENTIFIER=watchtower
      
      # --- OPCI√ìN 4: Microsoft Teams ---
      # - WATCHTOWER_NOTIFICATIONS=msteams
      # - WATCHTOWER_NOTIFICATION_MSTEAMS_HOOK_URL=https://outlook.office.com/webhook/XXX
      
      # ========================================================================
      # CONFIGURACI√ìN AVANZADA (Opcional)
      # ========================================================================
      
      # Logging (usar "debug" para troubleshooting)
      - WATCHTOWER_DEBUG=false
      - WATCHTOWER_TRACE=false
      
      # Zona horaria para logs
      - TZ=Europe/Madrid
      
      # Tiempo de espera para detener contenedores (segundos)
      - WATCHTOWER_TIMEOUT=10s
      
      # Rolling restarts (actualizar contenedores uno a uno si hay varios)
      - WATCHTOWER_ROLLING_RESTART=false
    
    networks:
      - app-network
    
    # Labels para auto-documentaci√≥n
    labels:
      - "description=Watchtower - Auto-actualiza contenedores Docker"

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  app-network:
    driver: bridge

# ============================================================================
# INSTRUCCIONES DE USO
# ============================================================================

# 1. REEMPLAZAR "usuario" con tu usuario de Docker Hub:
#    - L√≠nea 13: usuario/fastapi-web:1.5-alpine
#
# 2. ELEGIR TAG seg√∫n tu estrategia:
#    - alpine              ‚Üí √öltima versi√≥n siempre (RIESGO: puede romper)
#    - 1-alpine            ‚Üí Solo updates dentro de versi√≥n major 1.x.x
#    - 1.5-alpine          ‚Üí Solo updates de parches 1.5.x (RECOMENDADO)
#    - 1.5.2-alpine        ‚Üí Versi√≥n fija (NO auto-updates)
#
# 3. CONFIGURAR NOTIFICACIONES (opcional):
#    - Descomenta una de las opciones de notificaciones arriba
#    - Reemplaza XXX/YYY con tus webhooks reales
#
# 4. LEVANTAR SERVICIOS:
#    docker-compose -f docker-compose.watchtower.yml up -d
#
# 5. VERIFICAR QUE FUNCIONA:
#    docker logs -f watchtower
#    # Deber√≠as ver: "Checking for new images..."
#
# 6. FORZAR CHEQUEO MANUAL (sin esperar intervalo):
#    docker exec watchtower /watchtower --run-once
#
# 7. VER LOGS DE LA APLICACI√ìN:
#    docker logs -f fastapi-web
#
# 8. DETENER SERVICIOS:
#    docker-compose -f docker-compose.watchtower.yml down

# ============================================================================
# ESTRATEGIAS DE AUTO-UPDATE
# ============================================================================

# DESARROLLO (actualizaciones agresivas):
#   - Tag: alpine
#   - Intervalo: 300 (5 minutos)
#   - Riesgo: ALTO (puede romper con cambios incompatibles)
#
# STAGING (actualizaciones moderadas):
#   - Tag: 1-alpine
#   - Intervalo: 1800 (30 minutos)
#   - Riesgo: MEDIO (solo versiones major compatibles)
#
# PRODUCCI√ìN (actualizaciones conservadoras):
#   - Tag: 1.5-alpine
#   - Intervalo: 3600 (1 hora) o m√°s
#   - Riesgo: BAJO (solo parches de seguridad/bugfixes)
#
# ULTRA-CONSERVADOR (sin auto-updates):
#   - Tag: 1.5.2-alpine
#   - Watchtower en modo "monitor-only=true"
#   - Riesgo: NINGUNO (actualizaci√≥n manual despu√©s de testing)

# ============================================================================
# TROUBLESHOOTING
# ============================================================================

# Problema: Watchtower no actualiza nada
# Soluci√≥n:
#   1. Verifica que el label "watchtower.enable=true" est√° presente
#   2. Verifica que WATCHTOWER_LABEL_ENABLE=true en watchtower
#   3. Comprueba que hay una nueva imagen en Docker Hub:
#      docker pull usuario/fastapi-web:1.5-alpine
#   4. Revisa logs: docker logs watchtower

# Problema: Aplicaci√≥n se cae despu√©s de update
# Soluci√≥n:
#   1. Usa tag m√°s conservador (1.5-alpine en vez de alpine)
#   2. Agrega healthcheck m√°s robusto
#   3. Implementa estrategia de rollback autom√°tico (ver docs/AUTO-UPDATES-GUIA.md)

# Problema: Muchas notificaciones
# Soluci√≥n:
#   1. Aumenta WATCHTOWER_POLL_INTERVAL (ej: 7200 = 2 horas)
#   2. Filtra notificaciones solo para errores
#   3. Agrupa notificaciones diarias

# ============================================================================
# REFERENCIAS
# ============================================================================

# - Documentaci√≥n Watchtower: https://containrrr.dev/watchtower/
# - Gu√≠a completa auto-updates: docs/AUTO-UPDATES-GUIA.md
# - Sistema de tags: docs/DOCKER-TAGS-EXPLICACION.md
